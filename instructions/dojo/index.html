
<!doctype html>

<html>
<head>
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <meta name="theme-color" content="#4F7DC9">
  <meta charset="UTF-8">
  <title>DOJO - CI/CD DevOps</title>
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Code+Pro:400|Roboto:400,300,400italic,500,700|Roboto+Mono">
  <link rel="stylesheet" href="//fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="https://storage.googleapis.com/claat-public/codelab-elements.css">
  <style>
    .success {
      color: #1e8e3e;
    }
    .error {
      color: red;
    }
  </style>
</head>
<body>
  <google-codelab-analytics gaid="UA-49880327-14"></google-codelab-analytics>
  <google-codelab codelab-gaid=""
                  id="dojo"
                  title="DOJO - CI/CD DevOps"
                  environment="web"
                  feedback-link="https://github.com/tehioant/Dojo-cicd-devops-octo/issues/new">
    
      <google-codelab-step label="Overview" duration="2">
        <p>Objectifs pÃ©dagogique :</p>
<ul>
<li>DÃ©couvrir les concepts autour de l&#39;intÃ©gration continue,</li>
<li>Programmer un pipeline d&#39;intÃ©gration continue/une usine de dÃ©veloppement logiciel,</li>
<li>Obtenir du feedback frÃ©quemment grÃ¢ce aux tests automatisÃ©s,</li>
<li>Mesurer la qualitÃ© de son code,</li>
<li>Automatiser la production d&#39;artÃ©facts,</li>
<li>Creer une pipeline de release par tag.</li>
</ul>
<p>ğŸ‘‰ <a href="https://docs.google.com/presentation/d/1kRS86ba0FT6grKMrwFyHaTTzEwl_cAeZE8Euqx3e9kM/edit#slide=id.g804284dca3_0_176" target="_blank">Dispo sur le drive OCTO</a>.</p>


      </google-codelab-step>
    
      <google-codelab-step label="Presentation" duration="0">
        <h2 is-upgraded>Environment</h2>
<p>Ce produit comprend une Azure Function App <code>func-dojo-cicd-skool</code> composÃ© d&#39;une fonctino en typescript nommÃ© <code>DojoCicdSkool</code>.<br> Les developpeurs construisent une API. Pour permettre cela et produire du code de qualitÃ©, il faut de l&#39;automatisation et de l&#39;outillage ğŸ›  Cet outillage, c&#39;est gÃ©nÃ©ralement un pipeline, et on va en construire une utilisant Github actions pendant ce dojo ğŸ’ƒ</p>
<p>Le repository a 2 pipelines qui ont besoin d&#39;Ãªtre crÃ©Ã©</p>
<ul>
<li>ci.yml</li>
<li>release.yml</li>
</ul>
<pre><code language="language-text" class="language-text">Definition:
Continuous Integration is a software development practice where members of a team 
integrate their work frequently, usually each person integrates at least daily, 
leading to multiple integrations per day.
</code></pre>
<p>La pipeline doit contenir les jobs suivants:</p>
<ul>
<li>Lint</li>
<li>Unit tests</li>
<li>Build</li>
<li>Integration tests</li>
</ul>
<p class="image-container"><img src="img/28a4c8952a9f1dc6.png"></p>
<p>Pour les curieux qui veulent aller + loin sur la notion d&#39;intÃ©gration continue :</p>
<ul>
<li><a href="https://www.martinfowler.com/articles/continuousIntegration.html" target="_blank">https://www.martinfowler.com/articles/continuousIntegration.html</a></li>
<li><a href="https://blog.octo.com/tag/continuous-integration/" target="_blank">https://blog.octo.com/tag/continuous-integration/</a></li>
</ul>


      </google-codelab-step>
    
      <google-codelab-step label="Step 1 - Tests automatisÃ©s" duration="0">
        <p><strong>ğŸ¯ Goal</strong> : je veux obtenir du feedback sur le produit que je dÃ©veloppe via les tests</p>
<h2 is-upgraded>Local testing</h2>
<pre><code language="language-plaintext" class="language-plaintext">&gt; ğŸ•µï¸â€ Automatiser, c&#39;est rendre automatique une action qui Ã©tait jusque-lÃ  manuelle ğŸ’ª
</code></pre>
<p><strong>ğŸ‘‰ First, run tests on you computer !</strong></p>
<p>Au passage, prenez en note dans un fichier :</p>
<ul>
<li>les prÃ©-requis : les commandes ou paquets que vous avez dÃ» installer pour pouvoir lancer les tests,</li>
<li>le rÃ©sultat attendu : logs affichÃ©s en console, fichiers de rapport produits, ...</li>
</ul>
<p>ğŸ Exemple de rÃ©sultat attendu en lanÃ§ant les tests en local avec</p>
<pre><code language="language-shell" class="language-shell">$ npm test
</code></pre>
<p class="image-container"><img src="img/f7daecf816c3d06d.png"></p>
<h2 is-upgraded>Tips</h2>
<p>Vous pouvez utiliser Makefile pour opÃ©rer votre projet et faciliter son utilisation par tous.<br> Par example: <code>$ make test</code></p>


      </google-codelab-step>
    
      <google-codelab-step label="Step 2 - Tests automatisÃ©s (CI)" duration="0">
        <p><strong>ğŸ¯ Objectif</strong> : Je veux obtenir du feedback sur mes tests Ã  chaque commit poussÃ© sur ma branche de travail.</p>
<p><strong>Rendu attendu Ã  la fin de ce TP2</strong> : en poussant du code sur ma branche de travail, un pipeline doit se lancer automatiquement sur github. Cette pipeline doit permettre d&#39;exÃ©cuter les tests avec jest, comme ceci quand les tests sont au vert :</p>
<p class="image-container"><img src="img/93e09f70007a9b81.png"></p>
<h2 is-upgraded>Tests dans le pipeline de CI</h2>
<p>ğŸ‘‰ Edit the following file <a href="../.github/workflows/ci.yml" target="_blank">ci.yml</a> and add a stage named <code>function-tests</code>.</p>
<table>
<tr><td colspan="1" rowspan="1"><p>.</p>
</td><td colspan="1" rowspan="1"><p>.</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>âœ… SuccÃ¨s si tous les tests sont verts</p>
</td><td colspan="1" rowspan="1"><p>ğŸ”´ Echec si au moins 1 test est rouge</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p class="image-container"><img src="img/93e09f70007a9b81.png"></p>
</td><td colspan="1" rowspan="1"><p class="image-container"><img src="img/3ff0a90089f8c32c.png"></p>
</td></tr>
</table>
<p><strong>ğŸ Test de recette</strong> : Si la step <code>function-tests</code> s&#39;exÃ©cute bien dans votre pipeline de CI,</p>
<ul>
<li>elle devrait arborer une coche verte, <ul>
<li><img src="img/93e09f70007a9b81.png"></li>
</ul>
</li>
<li>et afficher les logs d&#39;exÃ©cution de la commande pytest en console. <ul>
<li><img src="img/20290cf61615b6ca.png"></li>
</ul>
</li>
</ul>
<p>â„¹ï¸ Si vous ne savez pas comment faire Ã©diter le pipeline, la partie ci-aprÃ¨s vous donnera un premier vernis sur les pipelines github et leur dÃ©claration en YAML.</p>
<pre><code language="language-yaml" class="language-yaml">## Un exemple de fichier ci.yml

env:
  FOO: bar

jobs:
  example-variable-1:
    runs-on: ubuntu-latest
    steps:
      - run: echo &#34;$FOO&#34; # bar

  example-variable-2:
    runs-on: ubuntu-latest
    env:
      FOO: override_at_job_level
    steps:
      - run: echo &#34;$FOO&#34; # override_at_job_level
</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="Step 3 - Jest report (bonus)" duration="0">
        <pre><code language="language-plaintext" class="language-plaintext">âš ï¸ Si vous vous sentez en retard; laissez de cotÃ© ce bonus; 
Vous pourrez y revenir plus tard ğŸ“… ğŸ± ğŸ”®
</code></pre>
<ol type="1">
<li>Dans le job <code>function-tests</code>, faites en sorte que <code>jest</code>  calcule la couverture de tests sur la fonction <code>DojoCicdSkool</code> et produise la mesure de couverture en console. <ol type="1">
<li>Vous pouvez utiliser <a href="https://jestjs.io/docs/cli" target="_blank">la commande â€“coverage</a> pour y arriver.</li>
</ol>
</li>
<li>Changez la destination de production de ces rapports afin de les produire dans un dossier <a href="../reports/jest" target="_blank">reports/jest/</a> Ã  la racine du repo.</li>
<li>Render les rapports du dossier <code>reports/</code> accessibles sous la forme d&#39;artÃ©facts.</li>
<li>Un exemple d&#39;utilisation de <a href="https://docs.github.com/en/actions/using-workflows/storing-workflow-data-as-artifacts" target="_blank">la fonctionnalitÃ© d&#39;artÃ©fact</a>.</li>
</ol>
<p><strong>ğŸ Test de recette : les rapports sont disponibles dans la partie Artifacts comme suit:</strong></p>
<p class="image-container"><img src="img/77cc004fd853b99f.png"></p>


      </google-codelab-step>
    
      <google-codelab-step label="Step 4 : Mesure de la qualitÃ© du code (local)" duration="0">
        <pre><code language="language-plaintext" class="language-plaintext">ğŸ¯ Objectif : Je veux obtenir du feedback sur la qualitÃ© du code sur commande.
</code></pre>
<p>ğŸ‘¨â€ğŸ‘¨â€ğŸ‘§â€ğŸ‘¦ La qualitÃ© du code, c&#39;est une notion subjective qui se dÃ©finit gÃ©nÃ©ralement en Ã©quipe. ğŸ“Š Une fois qu&#39;on l&#39;a dÃ©fini collectivement, on peut dÃ©finir des indicateurs pour la mesurer. ğŸ“¦ Certains package Typescript peuvent produire de tels indicateurs.</p>
<p><strong>Par exemple :</strong></p>
<ul>
<li><a href="https://typescript-eslint.io/" target="_blank">es-lint</a> est un linter de code TypeScript sur le style. Le nombre de warnings peut donner une indication de la <em>compliance</em> du code que l&#39;on a produit avec les standards de style reconnus dans l&#39;Ã©cosystÃ¨me TypeScript. ğŸ‘‰ On pourrait dÃ©finir que du code de qualitÃ©, c&#39;est du code qui respecte ces standards dÃ©finis par l&#39;Ã©quipe et dont le nombre de warning tend vers 0. <strong>Es-lint</strong> inclus <strong>prettier</strong> dans son package. Vous pouvez dÃ©finir vos rÃ¨gles d&#39;indentation pour conserver une continuitÃ© dans l&#39;Ã©quipe.</li>
<li><a href="https://docs.sonarqube.org/9.6/analyzing-source-code/languages/javascript-typescript-css/" target="_blank">sonarqube</a> est un outil de revue de code automatique et autogÃ©rer qui vous aide systÃ©matiquement Ã  fournir du <strong>clean code</strong>. Il donne un grand nombre d&#39;indications sur votre code et vos tests. Il permet de mesurer la couverture du code par les tests, c-a-d le ratio du nombre de lignes de code source traversÃ© par les tests sur le nombre de lignes de code total. Il permet aussi de detecter un certains nombre de failles de sÃ©curitÃ© tant dans le code que dans les CVE (Common vulnerabilities and exposures). ğŸ‘‰ On pourrait dÃ©finir que du code de qualitÃ©, c&#39;est du code oÃ¹ chaque ligne est testÃ©e, donc du code oÃ¹ le code coverage tend vers 100% (ou du moins dÃ©passe un seuil Ã©levÃ©, ex: 80%).</li>
<li><a href="https://github.com/IBM/audit-ci" target="_blank">audit-ci</a> est un outil concu pour le continuous integration qui nous permet de prevenir l&#39;intÃ©gration de code et de paquets contenant des vulnÃ©rabilitÃ©s. Vous pouvez customiser vos rÃ¨gles afin de filtrer vos autorisations.</li>
</ul>
<p>ğŸ‘‰ InsÃ©rez vos mÃ©triques favorites ici pour mesurer la qualitÃ© du code ou auditer du code ğŸ¤“</p>
<ul>
<li>Respect des ratios de la pyramide de tests,</li>
<li>Respect de la clean architecture,</li>
<li>Absence de code mort,</li>
<li>Nombre de bugs,</li>
<li>Seuil de complexitÃ© cyclomatique,</li>
<li>MÃ©triques de sÃ©curitÃ© (nombre de failles/CVE dans le code ou les dÃ©pendances),</li>
<li>MÃ©triques Accelerate (Lead time, MTTR, ...),</li>
<li>...</li>
</ul>
<p>ğŸ <strong>Objectifs :</strong></p>
<pre><code language="language-plaintext" class="language-plaintext">&gt; ğŸ•µï¸â€ Automatiser, c&#39;est rendre automatique une action qui Ã©tait jusque-lÃ  manuelle ğŸ’ª
</code></pre>
<p>ğŸ‘‰ Commencez par essayer de mesurer la qualitÃ© du code en local !</p>
<p>Sur votre poste local, installez les outils suivant, mesurez la qualitÃ© de votre code en ligne de commande et affichez les rÃ©sultats de mesure en console avec :</p>
<ul>
<li>es-lint</li>
<li>audit-ci</li>
<li>sonar</li>
</ul>
<p>ğŸ¯ Mesurez les indicateurs suivant sur vos postes, en local :</p>
<ul>
<li>Nombre de warnings sur le style du code avec es-lint,</li>
<li>Faites des analyses de sÃ©curitÃ© avec audit-ci et sonar,</li>
</ul>
<p>Comme prÃ©cÃ©demment, prenez en note :</p>
<ul>
<li>les prÃ©-requis : les commandes ou paquets que vous avez dÃ» installer pour pouvoir lancer les tests,</li>
<li>la commande que vous avez exÃ©cuter pour lancer les tests,</li>
<li>le rÃ©sultat attendu : logs affichÃ©s en console, fichiers de rapport produits, ...</li>
</ul>
<p>Cela nous servira pour reproduire cela dans notre pipeline de CI dans le prochain exercice.</p>


      </google-codelab-step>
    
      <google-codelab-step label="Step 5 : Mesure de la qualitÃ© du code (CI)" duration="0">
        <pre><code language="language-plaintext" class="language-plaintext">ğŸ¯ Objectif : Je veux obtenir du feedback sur la qualitÃ© du code automatiquement Ã  chaque push d&#39;un commit.
</code></pre>
<p>Le pipeline doit permettre</p>
<ul>
<li>d&#39;exÃ©cuter les tests avec Jest,</li>
<li>puis si les tests sont verts; exÃ©cuter les Ã©tapes de mesure la qualitÃ© du code dans un stage <code>code-quality</code> comme ceci :</li>
</ul>
<p class="image-container"><img src="img/2e6d42508b61b185.png"></p>
<ul>
<li>âœ… Le stage <code>code-quality</code> sera vert si votre base de code respecte les standards de es-lint, audit-ci, sonar (en bonus).</li>
<li>ğŸ”´ Le stage <code>code-quality</code> sera rouge si l&#39;un de ces outils d&#39;analyse relÃ¨ve au moins 1 warning.</li>
</ul>
<h2 is-upgraded>Autoriser l&#39;Ã©chec d&#39;une step</h2>
<p>Dans le TP suivant, nous allons ajouter une step supplÃ©mentaire au pipeline pour packager automatiquement l&#39;application</p>
<ul>
<li>si les tests sont verts,</li>
<li>et si le code produit est &#34;de qualitÃ© suffisante&#34;.</li>
</ul>
<p>En l&#39;Ã©tat, le code Python n&#39;est pas &#34;parfait&#34; concernant les outils d&#39;analyse que nous utilisons : il y a quelques warnings notables avec jest et sonar par exemple.</p>
<p>S&#39;il est utile de savoir que ces warnings existent, et qu&#39;il faudra les corriger, nous ne souhaitons pas pour autant que le pipeline de CI s&#39;arrÃªte sur cette Ã©tape <code>code-quality</code>.</p>
<p>Pour permettre au pipeline de continuer, github propose la fonctionnalitÃ© <a href="https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#jobsjob_idstepscontinue-on-error" target="_blank">continue-on-error</a>.</p>
<p>ğŸ <strong>Objectif : utilisez la fonctionnalitÃ© </strong></p>
<p><strong><em>continue-on-error</em></strong></p>
<p><strong> sur le stage </strong></p>
<p><strong><code>code-quality</code></strong></p>
<p><strong> pour permettre au pipeline de ne pas s&#39;arrÃªter mÃªme s&#39;il Ã©choue sur celui-ci.</strong></p>
<p><strong>Rendu attendu</strong> :</p>
<ul>
<li>âœ… Le stage <code>code-quality</code> sera vert si votre base de code respecte les standards de es-lint, audit-ci, sonar (en bonus).</li>
<li>âš ï¸ Le stage <code>code-quality</code> sera orange si l&#39;un de ces outils d&#39;analyse relÃ¨ve au moins 1 warning.</li>
<li><img src="img/807321af9245d9ff.png"></li>
</ul>


      </google-codelab-step>
    
      <google-codelab-step label="TP 6 : Packager du code de qualitÃ© (local)" duration="0">
        <pre><code language="language-plaintext" class="language-plaintext">ğŸ¯ Objectif : Je veux packager du code automatiquement.
</code></pre>
<pre><code language="language-shell" class="language-shell">cd func-dojo-cicd-skool;
npm run build
</code></pre>
<p>ğŸ <strong>Objectif 1 : Packagez l&#39;application en local.</strong></p>
<p>ğŸœ Test de recette : un dossier de la fonction devrait Ãªtre apparu dans le dossier dist/ â—ï¸</p>
<p>ğŸ <strong>Objectif 2 : Changez la version de l&#39;application en 1.18.27 avant de la packager.</strong></p>
<p>â„¹ï¸ Tips: vous pouvez utiliser la commande <code>npm version patch</code><br> ğŸœ Test de recette : le package possÃ¨de la version <strong>1.18.27</strong>, use <code>npm version</code></p>


      </google-codelab-step>
    
      <google-codelab-step label="TP 7 : Packager du code de qualitÃ© (en CI)" duration="0">
        <pre><code language="language-plaintext" class="language-plaintext">ğŸ¯ Objectif : je veux packager du code automatiquement Ã  chaque push d&#39;un commit, si et seulement si les tests passent et la qualitÃ© du code est acceptable.
</code></pre>
<p>Le pipeline doit permettre</p>
<ul>
<li>d&#39;Ã©xÃ©cuter les tests avec jest,</li>
<li>puis si les tests sont verts : exÃ©cuter les Ã©tapes de mesure la qualitÃ© du code dans un stage <code>code-quality</code></li>
<li>puis si les tests sont verts et la qualitÃ© OK : packager le code et bump la version.</li>
</ul>
<p>ğŸ <strong>Objectif 1 : Packagez l&#39;application en local au format Wheel.</strong></p>
<p>ğŸœ Test de recette : une nouvelle step <code>package-function</code> un nouveau stage <code>build</code> dans le pipeline de CI doit permettre de produire un dossier comme ceci :</p>
<p class="image-container"><img src="img/700760d1e274081d.png"></p>
<p>ï¸ğŸ <strong>Objectif 2 : Rendre le package accessible en artÃ©fact.</strong></p>
<p>ğŸœ Test de recette : la step <code>package-function</code> doit exposer le contenu du dossier dist/ en artÃ©fact afin de rendre le dossier tÃ©lÃ©chargeable depuis l&#39;interface web :</p>
<p class="image-container"><img src="img/dfaa16531f09437.png"></p>


      </google-codelab-step>
    
      <google-codelab-step label="BONUS : Deployer son artefact sur Azure (en CD)" duration="0">
        <pre><code language="language-plaintext" class="language-plaintext">ğŸ¯ Objectif : Je veux deployer mon artefact sur Azure
</code></pre>
<p>Dans ce dernier step Bonus, vous Ãªtes en autonomie. Nous voulons dÃ©ployer notre fonction sur un service Azure (Azure Function App). Pour ce faire, modifiez le code Terraform pour crÃ©er votre Azf et les resources nÃ©cessaires. Dans un nouveau stage <code>deploy</code>, lancer les commandes Terraform requis et publier votre artefact.</p>
<p>â›”ï¸ Important : Ne changez pas les skus du Terraform. Les resources doivent rester en free tier.</p>
<p>ğŸœ Test de recette : Une Azure Function App est dÃ©ployÃ©e sur le cloud et je peux appeler ma fonction en Http.</p>


      </google-codelab-step>
    
  </google-codelab>

  <script src="https://storage.googleapis.com/claat-public/native-shim.js"></script>
  <script src="https://storage.googleapis.com/claat-public/custom-elements.min.js"></script>
  <script src="https://storage.googleapis.com/claat-public/prettify.js"></script>
  <script src="https://storage.googleapis.com/claat-public/codelab-elements.js"></script>
  <script src="//support.google.com/inapp/api.js"></script>

</body>
</html>
